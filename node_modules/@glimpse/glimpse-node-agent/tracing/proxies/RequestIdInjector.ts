'use strict';

import { ProxyBase } from './ProxyBase';
import { RequestHelper, ResponseHelper} from '../../inspectors/util/HttpHelper';
import { GuidHelper } from '../../util/GuidHelper';

const REQUEST_ID_COOKIE = '.Glimpse.RequestId';

export class RequestIdInjector extends ProxyBase {

    public getModuleNames() {
        return [ 'http', 'https' ];
    }

    public init(httpModule) {
        const oldCreateServer = httpModule.createServer;
        httpModule.createServer = function createServer(...args) {
            const server = oldCreateServer.call(this, ...args);
            server.on('request', (req, res) => {
                const requestCookies = RequestHelper.parseCookies(req);
                const requestId = requestCookies ? requestCookies[REQUEST_ID_COOKIE] : undefined;
                if (!requestId && !res.headersSent) {
                    ResponseHelper.setCookie(res, REQUEST_ID_COOKIE, GuidHelper.newGuid(false));
                }
            });
            return server;
        };
    }
}
