'use strict';

var http = require('http');
var https = require('https');

var setupProxy = function setupProxy() {
    // Note: http.createServer and https.createServer have differnt signatures,
    // so we do each one separately here to keep things simple, even if there is
    // some duplicated code
    var oldHttpCreateServer = http.createServer;
    http.createServer = function createServer(callback) {
        var app = buildApp(callback);

        for (var _len = arguments.length, args = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
            args[_key - 1] = arguments[_key];
        }

        return oldHttpCreateServer.call.apply(oldHttpCreateServer, [this, app].concat(args));
    };

    var oldHttpsCreateServer = https.createServer;
    https.createServer = function createServer(options, callback) {
        var app = buildApp(callback);

        for (var _len2 = arguments.length, args = Array(_len2 > 2 ? _len2 - 2 : 0), _key2 = 2; _key2 < _len2; _key2++) {
            args[_key2 - 2] = arguments[_key2];
        }

        return oldHttpsCreateServer.call.apply(oldHttpsCreateServer, [this, options, app].concat(args));
    };
};

var buildApp = function buildApp(originalCallback) {

    // NOTE: Express provides wrappers around http for starting the web server. If used,
    //       apps may not otherwise import http themselves. In that case, the only mechanism
    //       for importing http (and thereby initializing the Glimpse proxy), is importing
    //       express. Since the server uses Express itself and is initialized before the
    //       agent, it needs to defer importing express until after agent initialization.
    //       This ensures that the first import of Express is done by the app itself and
    //       after all of the proxies have been registered.

    var express = require('express');
    var glimpse = require('../routes/glimpse');

    var app = express();

    app.use('/glimpse', glimpse);

    app.use(originalCallback);

    return app;
};

module.exports = setupProxy;
//# sourceMappingURL=../../maps/hosting/host-express.js.map
