'use strict';

import { IMessagePublisher } from '../messaging/IMessagePublisher';
import { IResource } from './IResource';
import { IServer } from '../IServer';

export class Resource implements IResource {
    private messagePublisher: IMessagePublisher;

    public constructor(server?: IServer) {
        if (server) {
            this.init(server.providers.messagePublisher);
        }
    }

    public init(messagePublisher: IMessagePublisher) {
        this.messagePublisher = messagePublisher;
    }

    public name = 'message-stream';
    public uriTemplate = '{?types,contextId}';
    public type = 'client';
    public invoke(req, res) {
        // TODO: Still need to complete pings (see #45)

        const types = req.query.types ? req.query.types.split(',') : [ ];
        const contextId = req.query.contextId;

        res.writeHead(200, {
            'Content-Type': 'text/event-stream',
            'Cache-Control': 'no-cache',
            'Connection': 'keep-alive'
        });

        const subscription = this.messagePublisher.streamMessages(
            contextId,
            types,
            (err, message) => {
                if (err) {
                    return err;
                }

                if (message) {
                    let payload = '';

                    payload += 'id: ' + message.context.id + '\n';
                    payload += 'event: ' + 'message' + '\n';
                    payload += 'data: ' + '[' + message.payload + ']' + '\n';
                    payload += '\n';

                    res.write(payload);
                }
                else {
                    res.end();
                }
            }
        );

        req.on('close', function done() {
            subscription.done();
        });
    };
}
