'use strict';

import { Hash } from '../services/hash';
import { IResource } from './IResource';
import { IResourceManager } from './IResourceManager';
import { IServer } from './../IServer';
import { UriTemplate } from './UriTemplate';

import * as _ from 'lodash';

export class Resource implements IResource {
    private resourceManager: IResourceManager;

    constructor(server: IServer) {
        this.resourceManager = server.providers.resourceManager;
    }

    public name = 'metadata';
    public uriTemplate = '?hash={hash}';
    public templateName = 'metadataTemplate';
    public type = 'client';
    public invoke(req, res) {
        const baseUri = req.protocol + '://' + req.get('host') + '/glimpse';

        const resources = _(this.resourceManager.resources)
            .reduce<{ [key: string]: string }>(
                (result, resource) => {
                    result[resource.name] = UriTemplate.fromResource(baseUri, resource);
                    return result;
                },
                {});

        const resourceHash = Hash.hashObject(resources);

        const metadata = {
            'resources': resources,
            'hash': resourceHash
        };

        res.json(metadata);
    };
}
